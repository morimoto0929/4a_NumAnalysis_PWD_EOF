# Q2: 15地点・秋季平均気温の年々変動に対するPCA/EOF解析

気象庁の15地点の気温データを用いて、秋季（9-11月）平均気温の年々変動に対して主成分分析（PCA/EOF解析）を行います。第1〜第3モードについて、有次元化した因子負荷量（EOFパターン）、規格化された主成分時系列（PC時系列）、寄与率を求めて提示します。

## ファイル構成

```
Q2/
├── pca_analysis.py            # メイン実行スクリプト
├── README.md                   # このファイル
├── src/                        # モジュール群
│   ├── __init__.py            # パッケージ初期化
│   ├── data_loader.py         # データ読み込み
│   ├── seasonal_average.py    # 季節平均計算
│   ├── pca_eof.py             # PCA/EOF解析
│   └── visualization.py       # プロット作成
└── output/                     # 出力ディレクトリ
    ├── pca_eof_EOF_dimensional.csv    # 有次元EOF（°C）
    ├── pca_eof_PC_standardized.csv    # 規格化PC（無次元）
    ├── pca_eof_variance.csv           # 寄与率
    ├── PC_timeseries.png              # PC時系列グラフ
    ├── EOF_pattern_bar.png            # EOF棒グラフ
    └── EOF_map_all_modes.png          # EOF地図
```

### モジュールの役割

- **data_loader.py**: 気象庁15地点の月平均気温データの読み込み（地点名、緯度、経度を含む）
- **seasonal_average.py**: 季節平均（秋季: 9-11月）の計算、欠損処理、年々偏差の計算
- **pca_eof.py**: 共分散行列の固有値分解、EOF/PC計算、寄与率算出、CSV保存
- **visualization.py**: PC時系列グラフ、EOFパターン棒グラフ、EOF地図の作成

## 実行方法

### 1. プロジェクトルートでuv環境をセットアップ（初回のみ）

```bash
cd /path/to/4a_NumAnalysis_PWD_EOF
uv sync
```

### 2. スクリプトの実行

#### デフォルトパラメータで実行

```bash
uv run Q2/pca_analysis.py
```

#### コマンドライン引数で実行（例：冬季DJFを解析）

```bash
uv run Q2/pca_analysis.py --season DJF --n_modes 3
```

#### 利用可能なコマンドライン引数

```bash
uv run Q2/pca_analysis.py --help
```

| 引数 | デフォルト | 説明 |
|------|-----------|------|
| `--input_file` | `../input/MonthlyMeanTemp15points.txt` | 入力データパス |
| `--output_dir` | `output` | 出力ディレクトリ |
| `--season` | `SON` | 季節の指定（SON/DJF/MAM/JJA） |
| `--n_modes` | `3` | 計算するモード数 |
| `--min_months` | `3` | 季節平均計算に必要な最低月数 |
| `--keep_incomplete` | `False` | 欠損がある年も使用（デフォルトは完全ケースのみ） |
| `--remove_trend` | `False` | 線形トレンドを除去 |
| `--no_adjust_sign` | - | EOFとPCの符号調整を無効化 |
| `--no_save_csv` | - | CSV保存を無効化 |
| `--no_plot_pc` | - | PC時系列プロットを無効化 |
| `--no_plot_eof_bar` | - | EOFパターン棒グラフを無効化 |
| `--no_plot_eof_map` | - | EOFパターン地図を無効化 |
| `--separate_pc_plots` | `False` | PC時系列を各モードで別々にプロット |
| `--dpi` | `300` | 図の解像度 |

実行すると、`Q2/output/` ディレクトリに以下のファイルが生成されます：

**CSV ファイル**:
- `pca_eof_EOF_dimensional.csv` - 有次元化EOF（単位: °C）
- `pca_eof_PC_standardized.csv` - 規格化PC（無次元、分散1）
- `pca_eof_variance.csv` - 固有値と寄与率

**画像ファイル**:
- `PC_timeseries.png` - 規格化PC時系列（第1〜第3モード）
- `EOF_pattern_bar.png` - EOFパターンの棒グラフ
- `EOF_map_all_modes.png` - EOFパターンの地図表示

## データ条件

### 入力データ

- **データファイル**: `input/MonthlyMeanTemp15points.txt`
- **観測所数**: 15地点（網走・根室・寿都・山形・石巻・伏木・飯田・銚子・境・浜田・彦根・宮崎・多度津・名瀬・石垣島）
- **データ期間**: 1897年12月〜（気象庁による長期観測）
- **データ内容**: 月平均気温（°C）
- **メタデータ**: 地点名、緯度、経度

### ファイルフォーマット

```
第1行: 観測所の地点名（タブ区切り）
第2行: 観測所の緯度
第3行: 観測所の経度
第4行以降: 年月（YYYYMM形式）、各地点の月平均気温（°C）
```

### 季節の定義

- **秋季（SON）**: 同一年の9月・10月・11月の平均
- **冬季（DJF）**: 前年12月、当年1月・2月の平均（年をまたぐ）
- **春季（MAM）**: 3月・4月・5月の平均
- **夏季（JJA）**: 6月・7月・8月の平均

## メイン関数: `run_pca_eof_analysis()`

### 関数シグネチャ

```python
def run_pca_eof_analysis(
    input_file,
    output_dir,
    season='SON',
    n_modes=3,
    min_months=3,
    remove_incomplete=True,
    remove_trend=False,
    adjust_sign=True,
    save_csv=True,
    plot_pc=True,
    plot_eof_bar=True,
    plot_eof_map_flag=True,
    separate_pc_plots=False,
    figsize_pc=(12, 8),
    figsize_eof_bar=(10, 6),
    figsize_eof_map=(15, 5),
    dpi=300
)
```

### 引数の説明

#### 必須引数

| 引数 | 型 | 説明 |
|------|-----|------|
| `input_file` | `str` | 入力データファイルのパス |
| `output_dir` | `str` | 出力先ディレクトリのパス |

#### オプション引数

| 引数 | 型 | デフォルト値 | 説明 |
|------|-----|-------------|------|
| `season` | `str` | `'SON'` | 季節の指定（'SON', 'DJF', 'MAM', 'JJA'） |
| `n_modes` | `int` | `3` | 計算するモード数 |
| `min_months` | `int` | `3` | 季節平均計算に必要な最低月数（3: 完全ケースのみ） |
| `remove_incomplete` | `bool` | `True` | 欠損がある年を除去するか |
| `remove_trend` | `bool` | `False` | 線形トレンドを除去するか |
| `adjust_sign` | `bool` | `True` | EOFとPCの符号を調整するか（主要地点が正になるように） |
| `save_csv` | `bool` | `True` | 結果をCSVで保存するか |
| `plot_pc` | `bool` | `True` | PC時系列をプロットするか |
| `plot_eof_bar` | `bool` | `True` | EOFパターンを棒グラフでプロットするか |
| `plot_eof_map_flag` | `bool` | `True` | EOFパターンを地図でプロットするか |
| `separate_pc_plots` | `bool` | `False` | PC時系列を各モードで別々にプロットするか |
| `figsize_pc` | `tuple` | `(12, 8)` | PC時系列の図のサイズ |
| `figsize_eof_bar` | `tuple` | `(10, 6)` | EOFパターン棒グラフの図のサイズ |
| `figsize_eof_map` | `tuple` | `(15, 5)` | EOFパターン地図の図のサイズ |
| `dpi` | `int` | `300` | 図の解像度 |

### 戻り値

```python
{
    'eigenvalues': ndarray,                    # 固有値（全モード）
    'eigenvectors': ndarray,                   # 固有ベクトル（全モード）
    'EOF_normalized': ndarray,                 # 正規化EOF（無次元、長さ1）
    'EOF_dimensional': ndarray,                # 有次元化EOF（°C単位）
    'PC_raw': ndarray,                         # 生の主成分時系列（°C単位）
    'PC_standardized': ndarray,                # 規格化PC（無次元、分散1）
    'explained_variance_ratio': ndarray,       # 寄与率（%）
    'cumulative_variance_ratio': ndarray,      # 累積寄与率（%）
    'years': list,                             # 年のリスト
    'stations': list,                          # 観測所名のリスト
    'n_modes': int,                            # モード数
    'n_years': int,                            # 年数
    'n_stations': int                          # 観測所数
}
```

## 解析手順

### 1. データ読み込み

- 気象庁15地点の月平均気温データを読み込み
- 地点名、緯度、経度のメタデータを取得
- 欠損値の有無をチェック

### 2. 季節平均の作成（年×地点行列）

秋季（SON）の場合、各年 y の秋季平均を計算：

```
T_{y,j}^{SON} = (T_{y,Sep,j} + T_{y,Oct,j} + T_{y,Nov,j}) / 3
```

これにより、行列 X ∈ ℝ^{Ny×15}（行=年、列=地点）を得る。

**欠損処理**（デフォルト）:
- 9-11月のうち欠損がある年・地点は除外（完全ケース）
- `min_months` 以上のデータがある場合のみ平均を計算

### 3. 年々偏差（アノマリー）への変換

各地点ごとに秋季平均の時間平均を引き、偏差行列 Z を作る：

```
T̄_j = (1/Ny) Σ_y X_{y,j}
Z_{y,j} = X_{y,j} - T̄_j
```

オプション: 線形トレンド除去（`remove_trend=True`）

### 4. 共分散行列の作成（15×15）

**共分散PCA**（単位を保つ）を使用：

```
V = (1/(Ny-1)) Z^T Z
```

ここで V ∈ ℝ^{15×15}

> 注: 相関PCA（標準化してから実施）も可能だが、本課題では有次元化EOFが必要なため共分散PCAを採用

### 5. 固有値分解（第3モードまで）

共分散行列 V の固有値問題を解く：

```
V e_k = λ_k e_k,  k=1,2,3,...
```

- 固有値は λ₁ ≥ λ₂ ≥ ... の降順に並べる
- 上位3つの固有ベクトル e₁, e₂, e₃ を「EOFの形（正規化EOF）」として採用

### 6. 主成分時系列（PC）の計算と規格化

各年の偏差ベクトル Z_y を EOF に射影して PC を得る：

```
PC_k(y) = Z_y · e_k
```

共分散PCAでは、理想的には Var(PC_k) = λ_k となる。

#### 規格化された主成分（無次元）

各モードで標準化する：

```
PC_k^(std)(y) = PC_k(y) / σ(PC_k) ≈ PC_k(y) / √λ_k
```

これにより PC_k^(std) は**分散1の無次元**時系列になる。

### 7. 有次元化した因子負荷量（EOFパターン）

「PCを規格化」したぶん、EOF側を有次元化して再構成の整合性を保つ：

```
EOF_k^(dim) = e_k σ(PC_k) ≈ e_k √λ_k
```

- e_k は無次元（長さ1）
- √λ_k は**気温の単位（°C）**を持つ
- よって EOF_k^(dim) は**°C**の有次元になり、「PCが1標準偏差のときの典型的空間振幅」を表す

この定義で偏差場は次で近似再構成できる：

```
Z_{y,·} ≈ Σ_{k=1}^3 PC_k^(std)(y) EOF_k^(dim)
```

### 8. 寄与率の算出（%）

各モードの寄与率（explained variance ratio）は：

```
r_k = (λ_k / Σ_{i=1}^{15} λ_i) × 100 (%)
```

第1〜第3モードについて数値で示す（例: Mode1: 42.3%）。

### 9. 符号の調整（オプション）

EOFとPCは同時に符号反転しても同じ解なので、見やすい向き（例: 主要地点が正になる）に調整可能。

- 各モードで最大絶対値を持つ地点が正になるように調整
- `adjust_sign=True` で自動調整（デフォルト）

## 出力内容

### A. 寄与率（数値）

コンソールに表示：

```
======================================================================
寄与率（Explained Variance Ratio）
======================================================================
Mode 1:  XX.XX% (累積:  XX.XX%)
Mode 2:  XX.XX% (累積:  XX.XX%)
Mode 3:  XX.XX% (累積:  XX.XX%)
======================================================================
```

### B. 規格化PC時系列（グラフ）

`PC_timeseries.png`:
- 横軸: 年
- 縦軸: PC_k^(std)（無次元）
- 第1〜第3モードの曲線（1つの図に3曲線、または別々に3枚）
- 0線を表示

### C. EOF（有次元因子負荷量）の提示

#### 1. 数値表（コンソール出力＋CSV）

コンソールに表示：

```
======================================================================
有次元EOF（因子負荷量）: 単位 °C
======================================================================
Station          Mode1    Mode2    Mode3
網走              X.XXX    X.XXX    X.XXX
根室              X.XXX    X.XXX    X.XXX
...
======================================================================
```

CSV保存: `pca_eof_EOF_dimensional.csv`

#### 2. 棒グラフ

`EOF_pattern_bar.png`:
- 各モードについて、15地点のEOF値を横棒グラフで表示
- 正の値は赤、負の値は青で色分け
- 単位: °C

#### 3. 地図表示

`EOF_map_all_modes.png`:
- 各地点に EOF_k^(dim) を色とサイズで表示
- カラーバーに単位（°C）を明記
- 3モード分の地図を横並びで作成
- カラーマップ: RdBu_r（赤=正、青=負）

## カスタマイズ例

### 冬季（DJF）の解析

```bash
uv run Q2/pca_analysis.py --season DJF
```

### 線形トレンド除去

```bash
uv run Q2/pca_analysis.py --remove_trend
```

### 5モードまで解析

```bash
uv run Q2/pca_analysis.py --n_modes 5
```

### 欠損を含む年も使用

```bash
uv run Q2/pca_analysis.py --keep_incomplete --min_months 2
```

### PC時系列を各モードで別々にプロット

```bash
uv run Q2/pca_analysis.py --separate_pc_plots
```

## 出力例

実行すると、以下のような情報がコンソールに表示されます：

```
======================================================================
15地点・秋季平均気温の年々変動に対するPCA/EOF解析
======================================================================

[1] データ読み込み
データ読み込み: /path/to/input/MonthlyMeanTemp15points.txt
観測所数: 15
観測所: 網走, 根室, 寿都, 山形, 石巻, 伏木, 飯田, 銚子, 境, 浜田, 彦根, 宮崎, 多度津, 名瀬, 石垣島
データ期間: 1897-12 ~ 20XX-XX
データ数: XXXX ヶ月

======================================================================
[2] 季節平均の計算
======================================================================
[季節平均の計算]
  季節: SON (月: [9, 10, 11])
  最低必要月数: 3
  年数: XXX
  観測所数: 15
  完全ケース（全地点でデータあり）: XXX 年

======================================================================
[3] 欠損値の処理（完全ケース抽出）
======================================================================
[完全ケースの抽出]
  元の年数: XXX
  完全ケース: XXX
  除外された年数: X

======================================================================
[4] 年々偏差（アノマリー）の計算
======================================================================
[年々偏差（アノマリー）の計算]
  時間平均（気候値）を除去しました
  年数: XXX
  観測所数: 15
  偏差の標準偏差（各地点の平均）: X.XXX °C

気候値（時間平均）:
  網走           : XX.XX °C
  根室           : XX.XX °C
  ...

======================================================================
[5] PCA/EOF解析
======================================================================
[PCA/EOF解析の実行]
  解析モード数: 3
  年数 (Ny): XXX
  観測所数 (n_stations): 15
  共分散行列のサイズ: (15, 15)
  固有値（上位3モード）:
    Mode 1: λ = X.XXXX
    Mode 2: λ = X.XXXX
    Mode 3: λ = X.XXXX
  ...

  寄与率:
    Mode 1: XX.XX% (累積: XX.XX%)
    Mode 2: XX.XX% (累積: XX.XX%)
    Mode 3: XX.XX% (累積: XX.XX%)

  PCA/EOF解析が完了しました。

======================================================================
[6] 結果の保存
======================================================================
  有次元EOFを保存: output/pca_eof_EOF_dimensional.csv
  規格化PCを保存: output/pca_eof_PC_standardized.csv
  寄与率を保存: output/pca_eof_variance.csv

======================================================================
[7] 可視化
======================================================================
  PC時系列を保存: output/PC_timeseries.png
  EOFパターン（棒グラフ）を保存: output/EOF_pattern_bar.png
  EOF地図（全モード）を保存: output/EOF_map_all_modes.png

======================================================================
[8] 結果の表示
======================================================================
[寄与率と数値表の表示...]

======================================================================
解析完了
======================================================================

結果は以下のディレクトリに保存されました:
  /path/to/Q2/output
```

## 結果の解釈

### Mode 1（第1主成分）

- **最大寄与率**を持つモード（通常40〜60%程度）
- 全国的に一様な温度変動（全地点が同符号）を表すことが多い
- 日本全体の気温の経年変化（地球温暖化トレンドなど）を反映

### Mode 2（第2主成分）

- **空間的コントラスト**を表すことが多い
- 例: 北日本と西日本の温度が逆符号（東西コントラスト、南北コントラスト）
- 大気循環パターン（冬型・夏型など）の影響を反映

### Mode 3（第3主成分）

- より複雑な空間パターン
- 局所的な変動や、特定の気候現象の影響を表す

### PC時系列の解釈

- **正の値**: EOF空間パターンの正方向（例: 全国的に高温）
- **負の値**: EOF空間パターンの負方向（例: 全国的に低温）
- **長期トレンド**: 気候変動の傾向
- **周期的変動**: エルニーニョ/ラニーニャなどの気候現象の影響

### EOF地図の解釈

- **赤色（正）**: PC時系列が正のとき、その地点の気温が平均より高い
- **青色（負）**: PC時系列が正のとき、その地点の気温が平均より低い
- **値の大きさ**: その地点がそのモードに強く寄与していることを示す

## 実装上の注意

### 符号の任意性

EOFとPCは同時に符号反転しても同じ解。本実装では、主要地点が正になるよう調整（`adjust_sign=True`）。

### 標準化の定義

本実装では「PCを分散1」に規格化し、EOF側を √λ_k で有次元化する流儀を採用。

別流儀（EOFを無次元、PCを有次元）を使う場合は、コード内の定義を変更する必要がある。

### 欠損処理

デフォルトでは完全ケース（全地点でデータがある年のみ）を使用。`--keep_incomplete` で欠損を含む年も使用可能だが、解釈に注意が必要。

## 参考

- 課題詳細: [instruction_Q2.md](../instruction_Q2.md)
- 入力データ: [MonthlyMeanTemp15points.txt](../input/MonthlyMeanTemp15points.txt)
- 気象庁: https://www.jma.go.jp/
